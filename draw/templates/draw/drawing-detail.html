{% extends 'draw/base.html' %}
{% block title %}{% if drawing %}{{ drawing }}{% else %}New Drawing{% endif %}{% endblock %}
{% block drawing_link %}
    {% if drawing %}
        <!--suppress ALL -->
        <li class="nav-item active"><a class="nav-link" href="{% url 'draw:drawing_detail' 1 drawing.id  %}"><i class="fas fa-image"></i>&nbsp; {{ drawing }}</a></li>
    {% endif %}
{% endblock %}
{% block new_drawing_active %}
    {% if not drawing %}
    active
    {% endif %}
{% endblock %}
{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.22/fabric.min.js"></script>
{% endblock %}

{% block detail_panel %}
    {% if not drawing %}<h3 style="text-align: center">New Drawing</h3>{% endif %}
    <form action="" method="post" enctype="multipart/form-data" style="padding: 10px">
    {% csrf_token %}
        <div class="form-row">
            <div class="col-auto">
                {{ form.title }}
            </div>
            <div class="col-auto">
                {{ form.project }}
            </div>
        </div><br>
        <div class="form-row">
            <div class="col">
                {{ form.description }}
            </div>
        </div><br>
        <div class="form-row">
            <div class="col-auto">
                <label for="">{{ form.is_pinned.label_tag }}</label>
            </div>
            <div class="col-auto">
                {{ form.is_pinned }}
            </div>
        </div><br>
        <div class="form-row">
            {{ form.json_string }}
        </div><br>
        <div class="form-row">
            <button type="button" class="btn btn-primary" onclick="saveJSON()" href="#">Save Drawing</button>&nbsp;
            <button type="button" class="btn btn-primary" onclick="loadJSON()" href="#">Load Drawing</button>&nbsp;
        </div><br>
        <div class="form-row">
            <button type="submit" class="btn btn-primary">Submit</button>
        </div>
    </form>
    {% if drawing %}
    <div class="col-auto">
    <form action="{% url 'draw:delete_drawing' drawing.project.id drawing.id 'delete' %}" method="post" class="form-group form-row">
        {% csrf_token %}
        <input type="hidden" name="drawing_id" value="{{ drawing.id }}">
        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure?');">Delete</button>
    </form>
    </div>
    {% endif %}
{% endblock %}

{% block list_panel %}
    <div class="row">
        <div class="col-4">
            <button id ="canvasInteract" type="button" class="btn btn-light" onclick="setInteractMode()" title="Move objects"><i class="fas fa-arrows-alt"></i></button>&nbsp;
            <button id ="deleteSelected" type="button" class="btn btn-light" onclick="deleteSelected()" title="Erase selected object"><i class="fas fa-eraser"></i></button>&nbsp;
            <button id="freeDraw" type="button" class="btn btn-light" role="button" aria-pressed="true" onclick="setDrawingMode()" title="Free Draw"><i class="fas fa-pencil-alt"></i></button>&nbsp;
            <button id="drawRect" type="button" class="btn btn-light" onclick="addRectangle()" title="Rectangle"><i class="far fa-square"></i></button>&nbsp;
            <button id ="drawCirc" type="button" class="btn btn-light" onclick="addCircle()" title="Circle"><i class="far fa-circle"></i></button>&nbsp;
        </div>
        <div class="col-2">

        </div>
        <div class="col-2">
            <button id ="deleteSelected" type="button" class="btn btn-danger" onclick="clearCanvas()" title="Clear canvas"><i class="fas fa-trash-alt"></i></button>
        </div>
    </div>
    <br>
    <canvas id="c" width="800" height="700" style="border: 1px solid black"></canvas>
    <script>

        //  initialise canvas and variables for drawing shapes
        var canvas = new fabric.Canvas('c',{backgroundColor : '#f8f9fa'});
        var drawingRect = false;
        var drawingCircle = false;
        var canvasInteractive = true;
        var rect, circ, dimXLeft, dimX, dimXRight, dimYTop, dimY, dimYBottom, isDown, origX, origY;
        var drawing_serial;
        var grid = 20;
        var scale = 0.25;
        loadJSON();
        renderGrid();
        setInteractive();
        canvas.renderAll();

        function saveJSON(){
            //  Need to pass our custom 'id' property to ensure it's loaded
            drawing_serial = JSON.stringify(canvas.toJSON(['id']));

            document.getElementById('id_json_string').value= drawing_serial;
        }

        function loadJSON(){

            canvas.loadFromJSON({{ drawing.json_string | safe }});
            //canvas.loadFromJSON(drawing_serial);
            renderGrid();
            //console.log(rect.id);
        }

        //  create grid
        function renderGrid(){
            console.log("Rendering grid");
            for (var i = 0; i < (800 / grid); i++) {
                var lineH = new fabric.Line([ i * grid, 0, i * grid, 800], { stroke: '#ccc', selectable: false, evented: false, excludeFromExport: true, id: 'grid' });
                var lineV = new fabric.Line([ 0, i * grid, 800, i * grid], { stroke: '#ccc', selectable: false, evented: false, excludeFromExport: true, id: 'grid' });
                canvas.add(lineH);
                canvas.add(lineV);
                canvas.sendToBack(lineH);
                canvas.sendToBack(lineV);
            }
        }

        function setInteractMode(){
            disableDrawing();
            disableRect();
            disableCircle();

            setInteractive();
        }

        function setInteractive(){
            if (canvasInteractive){
                canvas.forEachObject(function(object){
                    object.selectable = false
                });
                canvasInteractive = false;
                document.getElementById("canvasInteract").className = "btn btn-light"
            }
            else{
                canvas.forEachObject(function(object){
                    if (object.id != 'grid'){
                        object.selectable = true
                    }

                });
                //canvas.selection = false;
                canvasInteractive = true;
                //disableDrawing();
                //disableRect();
                //disableCircle();
                document.getElementById("canvasInteract").className += " btn-dark";
            }
        }

        function setDrawingMode() {
            canvas.isDrawingMode = true;
            disableInteract();
            disableRect();
            disableCircle();

            document.getElementById("freeDraw").className += " btn-dark";
        }

        function addRectangle(){
            drawingRect = true;
            disableInteract();
            disableDrawing();
            disableCircle();

            document.getElementById("drawRect").className += " btn-dark";
        }

        function addCircle(){
            drawingCircle = true;
            disableInteract();
            disableDrawing();
            disableRect();

            document.getElementById("drawCirc").className += " btn-dark";
        }

        //  toggle off methods
        function disableInteract(){
            canvasInteractive = true;
            setInteractive();
        }
        function disableDrawing(){
            canvas.isDrawingMode = false;
            document.getElementById("freeDraw").className = "btn btn-light";
        }
        function disableRect(){
            drawingRect = false;
            document.getElementById("drawRect").className = "btn btn-light";
        }
        function disableCircle(){
            drawingCircle = false;
            document.getElementById("drawCirc").className = "btn btn-light";
        }

        function deleteSelected(){
            var activeObject = canvas.getActiveObject(),
                activeGroup = canvas.getActiveGroup();

            if (activeObject){
                canvas.remove(activeObject);
            }
            else if (activeGroup){
                var groupObjects = activeGroup.getObjects();
                canvas.discardActiveGroup();
                groupObjects.forEach(function (object) {
                    canvas.remove(object);
                });
            }
            canvas.renderAll();
        }

        function clearCanvas(){

            canvas.clear();
            canvas.setBackgroundColor('#f8f9fa');
            renderGrid();
        }

        //  what to do when mouse button is down
        canvas.on('mouse:down', function(o){
            isDown = true;
            var pointer = canvas.getPointer(o.e);
            origX = pointer.x;
            origY = pointer.y;

            if (drawingRect){
                rect = new fabric.Rect({
                    left: origX,
                    top: origY,
                    originX: 'left',
                    originY: 'top',
                    width: pointer.x-origX,
                    height: pointer.y-origY,
                    angle: 0,
                    fill: 'rgba(0,0,0,0)',
                    stroke: 'black',
                    id: '1'
                });
                canvas.add(rect);
            }
            if (drawingCircle){
                circ = new fabric.Circle({
                    left: origX,
                    top: origY,
                    originX: 'left',
                    originY: 'top',
                    radius: (pointer.x-origX)/2,
                    fill: 'rgba(0,0,0,0)',
                    stroke: 'black',
                    id: '2'
                });
                canvas.add(circ);
            }
            if (canvasInteractive){
                if (canvas.getActiveObject() != null){
                    canvas.getActiveObject().on('moving', updateDimPosition);
                    canvas.getActiveObject().on('rotating', updateDimPosition);
                    canvas.getActiveObject().on('scaling', updateDimPosition);
                    bindElems();
                }
            }
        });

        //  what to do when the mouse moves, will not do anything if mouse is not down
        canvas.on('mouse:move', function(o){
            if (!isDown) return;
            var pointer = canvas.getPointer(o.e);
            if (drawingRect){
                if(origX>pointer.x){
                rect.set({ left: Math.abs(pointer.x) });
                }
                if(origY>pointer.y){
                    rect.set({ top: Math.abs(pointer.y) });
                }

                rect.set({ width: Math.abs(origX - pointer.x) });
                rect.set({ height: Math.abs(origY - pointer.y) });


                canvas.renderAll();
            }
            if (drawingCircle){
                if(origX>pointer.x){
                circ.set({ left: Math.abs(pointer.x) });
                }
                if(origY>pointer.y){
                    circ.set({ top: Math.abs(pointer.y) });
                }

                circ.set({ radius: Math.abs((origX - pointer.x)/2) });


                canvas.renderAll();
            }

        });

        //  what do when mouse button is lifted
        canvas.on('mouse:up', function(o){
            isDown = false;
            var hopefullyUniqueId = Math.random().toString(16).slice(2);
            if(drawingRect){
                rect.set({ id: hopefullyUniqueId });
                if (rect.width != 0 && rect.height != 0){
                    dimXLeft = new fabric.Text('←', { left: rect.left, top: rect.top - 50, fontSize: 29, id: rect.id});
                    dimX = new fabric.Textbox(' ' + rect.width*scale + ' ', { left: dimXLeft.left + dimXLeft.width, top: rect.top - 50, fontSize: 29, width: rect.width - dimXLeft.width*2, id: rect.id, textAlign: 'center' });
                    dimXRight = new fabric.Text('→', { left: dimXLeft.left + dimX.width + dimXLeft.width, top: rect.top - 50, fontSize: 29, id: rect.id });

                    dimYTop = new fabric.Text('↑', { left: rect.left - 50, top: rect.top, fontSize: 29, id: rect.id});
                    dimY = new fabric.Textbox(' ' + rect.height*scale + ' ', { left: rect.left - 75, top: rect.top + 70, height: rect.height - dimYTop.height*2, fontSize: 29, id: rect.id, textAlign: 'center' });
                    dimYBottom = new fabric.Text('↓', { left: rect.left - 50, top: rect.top + rect.height - dimYTop.height, fontSize: 29, id: rect.id });
                    rect.setCoords();

                    canvas.add(dimXLeft, dimX, dimXRight, dimYTop, dimY, dimYBottom);
                }
            }
            else if (drawingCircle){
                circ.set({ id: hopefullyUniqueId });
                if (circ.radius != 0){
                    dimXLeft = new fabric.Text('←', { left: circ.left, top: circ.top - 50, fontSize: 29, id: circ.id});
                    dimX = new fabric.Textbox(' ' + (circ.radius*2)*scale + ' ', { left: dimXLeft.left + dimXLeft.width, top: circ.top - 50, fontSize: 29, width: circ.radius*2 - dimXLeft.width*2, id: circ.id, textAlign: 'center' });
                    dimXRight = new fabric.Text('→', { left: dimXLeft.left + dimX.width + dimXLeft.width, top: circ.top - 50, fontSize: 29, id: circ.id });

                    circ.setCoords();
                    canvas.add(dimXLeft, dimX, dimXRight);
                }
            }
            setInteractive();
            setInteractive();
        });

        //  Figure out where to put this shit
        var multiply = fabric.util.multiplyTransformMatrices;
        var invert = fabric.util.invertTransform;

        function updateDimPosition() {
        var dims = canvas.getObjects().filter(o => o.id === canvas.getActiveObject().id);
        dims.forEach(o => {
            if (!o.relationship) {
            return;
            }
            var relationship = o.relationship;
            var newTransform = multiply(
            canvas.getActiveObject().calcTransformMatrix(),
            relationship
            );
            opt = fabric.util.qrDecompose(newTransform);
            o.set({
            flipX: false,
            flipY: false,
            });
            o.setPositionByOrigin(
            { x: opt.translateX, y: opt.translateY },
            'center',
            'center'
            );
            o.set(opt);
            o.setCoords();
        });
        }
        //
        function bindElems() {
        var dims = canvas.getObjects().filter(o => o.id == canvas.getActiveObject().id);
        var shapeTransform = canvas.getActiveObject().calcTransformMatrix();
        var invertedshapeTransform = invert(shapeTransform);
        dims.forEach(o => {
            var desiredTransform = multiply(
            invertedshapeTransform,
            o.calcTransformMatrix()
            );
            // save the desired relation here.
            o.relationship = desiredTransform;
        });
        }
    </script>
{% endblock %}
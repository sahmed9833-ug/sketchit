<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw Test</title>

    <link rel="shortcut icon" href="http://icons.iconarchive.com/icons/custom-icon-design/pretty-office-10/512/Pencil-icon.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Poppins|Shadows+Into+Light" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.22/fabric.min.js"></script>
    <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand website-logo" href="#">Sketch-It-Yourself. </a>
        <!-- Nav bar toggle and logo -->
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <!-- Nav bar list items -->
        <div class="collapse navbar-collapse" id="navbarNav">
            <!-- left side -->
            <ul class="navbar-nav mr-auto">
                <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-project-diagram" aria-hidden="true"></i>&nbsp; Projects <span class="sr-only">(current)</span></a></li>
                <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-images"></i>&nbsp; Drawings</a></li>

                <li class="nav-item active" style="border-left: #1b1e21 solid 1px; padding-left: 5px; margin-left: 5px"><a class="nav-link" href=""><i class="fas fa-plus"></i>&nbsp; New Drawing</a></li>
            </ul>
            <!-- right side -->
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-user-plus"></i>&nbsp; Register</a></li>
                <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-sign-in-alt"></i>&nbsp; Log In</a></li>
            </ul>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 detail-panel">
            <h2>This is a static page intended for testing the web-app's drawing component.</h2>
            <p>Other components (such as nav links) are non-functioning in this build.</p>
            </div>
            <div id="list-panel" class="col-md-9 list-panel">
        <div class="row">
            <div class="col-4">
                <button id ="canvasInteract" type="button" class="btn btn-light" onclick="setInteractMode()" title="Move objects"><i class="fas fa-arrows-alt"></i></button>&nbsp;
                <button id ="deleteSelected" type="button" class="btn btn-light" onclick="deleteSelected()" title="Erase selected object"><i class="fas fa-eraser"></i></button>&nbsp;
                <button id="freeDraw" type="button" class="btn btn-light" role="button" aria-pressed="true" onclick="setDrawingMode()" title="Free Draw"><i class="fas fa-pencil-alt"></i></button>&nbsp;
                <button id="drawRect" type="button" class="btn btn-light" onclick="addRectangle()" title="Rectangle"><i class="far fa-square"></i></button>&nbsp;
                <button id ="drawCirc" type="button" class="btn btn-light" onclick="addCircle()" title="Circle"><i class="far fa-circle"></i></button>&nbsp;
            </div>
            <div class="col-2">

            </div>
            <div class="col-2">
                <button id ="deleteSelected" type="button" class="btn btn-danger" onclick="clearCanvas()" title="Clear canvas"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
    <br>
    <canvas id="c" width="800" height="700" style="border: 1px solid black"></canvas>
    <script>
        //  TODO: Strongly consider putting all of this into its own js file.

        //  initialise canvas and variables for drawing shapes
        var canvas = new fabric.Canvas('c',{backgroundColor : '#f8f9fa'});
        var drawingRect = false;
        var drawingCircle = false;
        var canvasInteractive = true;
        var rect, circ, isDown, origX, origY;
        var grid = 20;
        renderGrid();
        setInteractive();
        canvas.renderAll();

        //  create grid
        //  TODO: Consider putting up a background image rather than doing this - allows for group selection
        function renderGrid(){
            console.log("Rendering grid");
            for (var i = 0; i < (800 / grid); i++) {
                var lineH = new fabric.Line([ i * grid, 0, i * grid, 800], { stroke: '#ccc', selectable: false, evented: false, excludeFromExport: true });
                var lineV = new fabric.Line([ 0, i * grid, 800, i * grid], { stroke: '#ccc', selectable: false, evented: false, excludeFromExport: true });
                canvas.add(lineH);
                canvas.add(lineV);
                canvas.sendToBack(lineH);
                canvas.sendToBack(lineV);
            }
        }

        function setInteractMode(){
            disableDrawing();
            disableRect();
            disableCircle();

            setInteractive();
        }

        function setInteractive(){
            if (canvasInteractive){
                canvas.forEachObject(function(object){
                    object.selectable = false
                });
                canvasInteractive = false;
                document.getElementById("canvasInteract").className = "btn btn-light"
            }
            else{
                canvas.forEachObject(function(object){
                    object.selectable = true
                });
                canvas.selection = false;
                canvasInteractive = true;
                //disableDrawing();
                //disableRect();
                //disableCircle();
                document.getElementById("canvasInteract").className += " btn-dark";
            }
        }

        function setDrawingMode() {
            canvas.isDrawingMode = true;
            disableInteract();
            disableRect();
            disableCircle();

            document.getElementById("freeDraw").className += " btn-dark";
        }

        function addRectangle(){
            drawingRect = true;
            disableInteract();
            disableDrawing();
            disableCircle();

            document.getElementById("drawRect").className += " btn-dark";
        }

        function addCircle(){
            drawingCircle = true;
            disableInteract();
            disableDrawing();
            disableRect();

            document.getElementById("drawCirc").className += " btn-dark";
        }

        //  toggle off methods
        function disableInteract(){
            canvasInteractive = true;
            setInteractive();
        }
        function disableDrawing(){
            canvas.isDrawingMode = false;
            document.getElementById("freeDraw").className = "btn btn-light";
        }
        function disableRect(){
            drawingRect = false;
            document.getElementById("drawRect").className = "btn btn-light";
        }
        function disableCircle(){
            drawingCircle = false;
            document.getElementById("drawCirc").className = "btn btn-light";
        }

        function deleteSelected(){
            canvas.remove(canvas.getActiveObject());
            canvas.renderAll();
        }

        function clearCanvas(){

            canvas.clear();
            canvas.setBackgroundColor('#f8f9fa');
            renderGrid();
        }

        //  what to do when mouse button is down
        canvas.on('mouse:down', function(o){
            isDown = true;
            var pointer = canvas.getPointer(o.e);
            origX = pointer.x;
            origY = pointer.y;

            if (drawingRect){
                rect = new fabric.Rect({
                left: origX,
                top: origY,
                originX: 'left',
                originY: 'top',
                width: pointer.x-origX,
                height: pointer.y-origY,
                angle: 0,
                fill: 'rgba(0,0,0,0)',
                stroke: 'black'
                });
                canvas.add(rect);
            }
            if (drawingCircle){
                circ = new fabric.Circle({
                    left: origX,
                    top: origY,
                    originX: 'left',
                    originY: 'top',
                    radius: (pointer.x-origX)/2,
                    fill: 'rgba(0,0,0,0)',
                    stroke: 'black'
                });
                canvas.add(circ);
            }
        });

        //  what to do when the mouse moves, will not do anything if mouse is not down
        canvas.on('mouse:move', function(o){
            if (!isDown) return;
            var pointer = canvas.getPointer(o.e);
            if (drawingRect){
                if(origX>pointer.x){
                rect.set({ left: Math.abs(pointer.x) });
                }
                if(origY>pointer.y){
                    rect.set({ top: Math.abs(pointer.y) });
                }

                rect.set({ width: Math.abs(origX - pointer.x) });
                rect.set({ height: Math.abs(origY - pointer.y) });


                canvas.renderAll();
            }
            if (drawingCircle){
                if(origX>pointer.x){
                circ.set({ left: Math.abs(pointer.x) });
                }
                if(origY>pointer.y){
                    circ.set({ top: Math.abs(pointer.y) });
                }

                circ.set({ radius: Math.abs((origX - pointer.x)/2) });


                canvas.renderAll();
            }

        });

        //  what do when mouse button is lifted
        canvas.on('mouse:up', function(o){
            isDown = false;
            if(drawingRect)
                rect.setCoords();
            else if (drawingCircle)
                circ.setCoords();

            setInteractive();
            setInteractive();

        });
    </script>
                <br>
            </div>
        </div>
        <div class="row">
            <div class="container-fluid site-footer">
                <span class="sig">Sketch-It-Yourself</span>
                <p style="color: #c1c1c1; font-size: 15px; font-family: 'Times New Roman', Serif;">Completed as part of the MSc Computing Science programme at the University of Glasgow &copy; 2018</p>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</body>
</html>
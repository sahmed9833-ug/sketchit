<!DOCTYPE html>
<!--suppress ALL -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw Test</title>

    <link rel="shortcut icon" href="http://icons.iconarchive.com/icons/custom-icon-design/pretty-office-10/512/Pencil-icon.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Poppins|Shadows+Into+Light" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.22/fabric.min.js"></script>
    <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand website-logo" href="#">Sketch-It-Yourself. </a>
        <!-- Nav bar toggle and logo -->
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <!-- Nav bar list items -->
        <div class="collapse navbar-collapse" id="navbarNav">
            <!-- left side -->
            <ul class="navbar-nav mr-auto">
                <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-project-diagram" aria-hidden="true"></i>&nbsp; Projects <span class="sr-only">(current)</span></a></li>
                <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-images"></i>&nbsp; Drawings</a></li>

                <li class="nav-item active" style="border-left: #1b1e21 solid 1px; padding-left: 5px; margin-left: 5px"><a class="nav-link" href=""><i class="fas fa-plus"></i>&nbsp; New Drawing</a></li>
            </ul>
            <!-- right side -->
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-user-plus"></i>&nbsp; Register</a></li>
                <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-sign-in-alt"></i>&nbsp; Log In</a></li>
            </ul>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 detail-panel">
            <h2>This HTML page is intended for testing of the web-app's drawing component</h2>
            <p>Other components (such as nav links, save/load etc.) are non-functioning in this build.</p>
            </div>
            <div id="list-panel" class="col-md-9 list-panel">
        <div class="row">
        <div class="col-3">
            <!-- TODO: Consider having a "Select" mode -->
            <button id ="canvasInteract" type="button" class="btn btn-light" onclick="setInteractMode()" title="Move objects"><i class="fas fa-arrows-alt"></i></button>&nbsp;
            <button id ="deleteSelected" type="button" class="btn btn-light" onclick="deleteSelected()" title="Erase selected object"><i class="fas fa-eraser"></i></button>&nbsp;
            <button id="freeDraw" type="button" class="btn btn-light" role="button" aria-pressed="true" onclick="setDrawingMode()" title="Free Draw"><i class="fas fa-pencil-alt"></i></button>&nbsp;
            <button id="drawLine" type="button" class="btn btn-light" onclick="addLine()" title="Line"><strong>‚üç</strong></button>&nbsp;
            <button id="drawRect" type="button" class="btn btn-light" onclick="addRectangle()" title="Rectangle"><i class="far fa-square"></i></button>&nbsp;
            <button id ="drawCirc" type="button" class="btn btn-light" onclick="addCircle()" title="Circle"><i class="far fa-circle"></i></button>&nbsp;
            <button id ="clearCanvas" type="button" class="btn btn-danger" onclick="clearCanvas()" title="Clear canvas" style="margin-top: 10px"><i class="fas fa-trash-alt"></i></button>
        </div>
        <div class="col-4">
            <div class="input-group">
                <div class="input-group-prepend">

                    <span class="input-group-text" id="">Scale</span>
                    <button id="setScaling" type="button" class="btn btn-dark" onclick="setScalingMode()"><i class="fas fa-i-cursor"></i></button>&nbsp;
                </div>
                <input id="scaleInput" type="text" class="form-control" onblur="updateScale()" placeholder="0.25" value="0.25">&nbsp;
            </div>
        </div>
        <div class="col-2">
            <button id ="hideDimX" type="button" class="btn btn-light" onclick="hideDimX()" title="Show or Hide selected shape's X dimension">Show/Hide <i class="fas fa-arrows-alt-h"></i></button>&nbsp;

            <button id="repositionDimX" type="button" class="btn btn-light" onclick="repositionDimX()" title="Reposition selected shape's X dimension" style="margin-top: 10px">Reposition <i class="fas fa-arrows-alt-h"></i></button>
        </div>
        <div class="col-2">
            <button id ="hideDimY" type="button" class="btn btn-light" onclick="hideDimY()" title="Show or Hide selected shape's Y dimension">Show/Hide <i class="fas fa-arrows-alt-v"></i></button>&nbsp;
            <button id="repositionDimY" type="button" class="btn btn-light" onclick="repositionDimY()" title="Reposition selected shape's Y dimension" style="margin-top: 10px">Reposition <i class="fas fa-arrows-alt-v"></i></button>
        </div>
    </div>
        <canvas id="c" width="800" height="700" style="border: 1px solid black; margin-top: 5px"></canvas>
    <script>
        //  override library's controls appearance
    fabric.Object.prototype.set({
        borderColor: 'green',
        cornerSize: 16,
        cornerColor: 'blue'});

    //  override how fabric renders stroke, from https://stackoverflow.com/a/48343346
    fabric.Object.prototype._renderStroke = function (ctx) {
        if (!this.stroke || this.strokeWidth === 0) {
            return;
        }
        if (this.shadow && !this.shadow.affectStroke) {
            this._removeShadow(ctx);
        }
        ctx.save();
        // if (this.strokeUniform)
        ctx.scale(1 / this.scaleX, 1 / this.scaleY);
        this._setLineDash(ctx, this.strokeDashArray, this._renderDashedStroke);
        this._applyPatternGradientTransform(ctx, this.stroke);
        ctx.stroke();
        ctx.restore();
    };

    // const _getTransformedDimensions = fabric.Object.prototype._getTransformedDimensions;
    fabric.Object.prototype._getTransformedDimensions = function (skewX, skewY) {
        // if (!this.strokeUniform)
        //     return _getTransformedDimensions.call(this, e, t);
        if (typeof skewX === 'undefined') {
            skewX = this.skewX;
        }
        if (typeof skewY === 'undefined') {
            skewY = this.skewY;
        }
        const dimX = this.width / 2,
            dimY = this.height / 2;

        let points = [{
            x: -dimX,
            y: -dimY
        }, {
            x: dimX,
            y: -dimY
        }, {
            x: -dimX,
            y: dimY
        }, {
            x: dimX,
            y: dimY
        }];
        const transformMatrix = this._calcDimensionsTransformMatrix(skewX, skewY, false);
        for (let i = 0; i < points.length; i++) {
            points[i] = fabric.util.transformPoint(points[i], transformMatrix);
        }
        const bbox = fabric.util.makeBoundingBoxFromPoints(points);
        return {
            y: bbox.height + this.strokeWidth,
            x: bbox.width + this.strokeWidth,
        };
    };


    //  modify Textbox slightly to exit editing when the Enter key is pressed
    fabric.Textbox.prototype.onKeyDown = (function(onKeyDown) {
        return function(e) {
        if (e.keyCode == 13)
            canvas.getActiveObject().exitEditing();
        onKeyDown.call(this, e);
      }
    })(fabric.Textbox.prototype.onKeyDown)

        //  initialise canvas and set initial values for variables
        var canvas = new fabric.Canvas('c',{ backgroundColor : '#f8f9fa', hoverCursor: 'pointer'});

        var drawingRect = false;
        var drawingCircle = false;

        var drawingLine = false;
        var arr = new Array();
		var startx = new Array();
		var endx = new Array();
		var starty = new Array();
		var endy = new Array();
		var temp = 0;
		var graphtype;
        var text;

        var canvasInteractive = true;
        var scalingMode = true;
        var rect, circ, dimXLeft, dimX, dimXRight, dimYTop, dimY, dimYBottom, isDown, origX, origY;
        var drawing_serial;
        var arrowWidth = 34.2;
        var constStrokeWidth = 2;
        var grid = 20;
            var scale = 0.25;
        //loadJSON();
        renderGrid();
        setInteractive();
        canvas.renderAll();

        //  create grid
        function renderGrid(){
            console.log("Rendering grid");
            for (var i = 0; i < (800 / grid); i++) {
                var lineH = new fabric.Line([ i * grid, 0, i * grid, 800], { stroke: '#ccc', selectable: false, evented: false, excludeFromExport: true, id: 'grid' });
                var lineV = new fabric.Line([ 0, i * grid, 800, i * grid], { stroke: '#ccc', selectable: false, evented: false, excludeFromExport: true, id: 'grid' });
                canvas.add(lineH);
                canvas.add(lineV);
                canvas.sendToBack(lineH);
                canvas.sendToBack(lineV);
            }
        }

        function setScalingMode(){
            if (scalingMode){
                scalingMode = false;
                document.getElementById("setScaling").className = "btn btn-light";
            }
            else{
                scalingMode = true;
                document.getElementById("setScaling").className += " btn-dark";
            }
        }

        function setInteractMode(){
            disableDrawing();
            disableRect();
            disableCircle();
            disableLine();

            setInteractive();
        }

        function setInteractive(){
            if (canvasInteractive){
                canvas.forEachObject(function(object){
                    object.selectable = false
                });
                canvasInteractive = false;
                document.getElementById("canvasInteract").className = "btn btn-light"
            }
            else{
                canvas.forEachObject(function(object){
                    if (object.id != 'grid' && object.hidden != true){
                        object.selectable = true
                    }

                });
                canvasInteractive = true;
                document.getElementById("canvasInteract").className += " btn-dark";
            }
        }

        function setDrawingMode() {
            canvas.isDrawingMode = true;
            disableInteract();
            disableRect();
            disableCircle();
            disableLine();

            document.getElementById("freeDraw").className += " btn-dark";
        }

        function deleteSelected(){
            var activeObject = canvas.getActiveObject(),
                activeGroup = canvas.getActiveGroup();

            if (activeObject){
                var dims = canvas.getObjects().filter(o => o.id === activeObject.id);

                dims.forEach(o => {
                    canvas.remove(o);
                });

                canvas.remove(activeObject);
            }
            else if (activeGroup){
                var groupObjects = activeGroup.getObjects();
                canvas.discardActiveGroup();
                groupObjects.forEach(function (object) {
                    canvas.remove(object);
                });
            }
            canvas.renderAll();
        }

        function addRectangle(){
            drawingRect = true;
            disableInteract();
            disableDrawing();
            disableCircle();
            disableLine();

            document.getElementById("drawRect").className += " btn-dark";
        }

        function addCircle(){
            drawingCircle = true;
            disableInteract();
            disableDrawing();
            disableRect();
            disableLine();

            document.getElementById("drawCirc").className += " btn-dark";
        }

        function addLine(){
            drawingLine = true;
            disableInteract();
            disableDrawing();
            disableRect();
            disableCircle();

            document.getElementById("drawLine").className += " btn-dark";
        }

        function updateScale(){
            scale = document.getElementById('scaleInput').value;
        }

        function clearCanvas(){

            canvas.clear();
            canvas.setBackgroundColor('#f8f9fa');
            renderGrid();
        }

        //  toggle off methods
        function disableInteract(){
            canvasInteractive = true;
            setInteractive();
        }
        function disableDrawing(){
            canvas.isDrawingMode = false;
            document.getElementById("freeDraw").className = "btn btn-light";
        }
        function disableRect(){
            drawingRect = false;
            document.getElementById("drawRect").className = "btn btn-light";
        }
        function disableCircle(){
            drawingCircle = false;
            document.getElementById("drawCirc").className = "btn btn-light";
        }
        function disableLine(){
            drawingLine = false;
            document.getElementById("drawLine").className = "btn btn-light";
        }

        function hideDimX(){
            var dims = canvas.getObjects().filter(o => o.id === canvas.getActiveObject().id && o.category === 'dimX' | o.category === 'dimCirc');

            dims.forEach(o => {
                if (o.opacity == 0){
                    o.set({ opacity: 100, selectable: true, hidden: false });
                }
                else{
                    o.set({ opacity: 0, selectable: false, hidden: true });
                }
            });
            canvas.renderAll();
        }

        function hideDimY(){
            var dims = canvas.getObjects().filter(o => o.id === canvas.getActiveObject().id && o.category == 'dimY');

            dims.forEach(o => {
                if (o.opacity == 0){
                    o.set({ opacity: 100, selectable: true, hidden: false });
                }
                else{
                    o.set({ opacity: 0, selectable: false, hidden: true });
                }
            });
            canvas.renderAll();
        }

        function repositionDimX(){
            var dims = canvas.getObjects().filter(o => o.id === canvas.getActiveObject().id && o.category === 'dimX' | o.category === 'dimCirc');

            dims.forEach(o => {
                o.set({ positionOutside: !o.positionOutside });
                if (o.category === 'dimCirc'){
                    if (!o.positionOutside){
                        o.set({ top: canvas.getActiveObject().top + canvas.getActiveObject().getRadiusX()*0.85});
                    }
                    else{
                        o.set({ top: canvas.getActiveObject().top - 50 });
                    }
                }
                else if (!o.positionOutside){
                    o.set({ top: canvas.getActiveObject().top + 25 });
                }
                else{
                    o.set({ top: canvas.getActiveObject().top - 50 });
                }
            });
            canvas.renderAll();
        }

        function repositionDimY(){
            var dims = canvas.getObjects().filter(o => o.id === canvas.getActiveObject().id && o.category === 'dimY');

            dims.forEach( o => {
                o.set({ positionOutside: !o.positionOutside});

                if (!o.positionOutside){
                    o.set({ left: canvas.getActiveObject().left + 25 });
                }
                else{
                    o.set({ left: canvas.getActiveObject().left - 50});
                }
            });
            canvas.renderAll();
        }

        //  what to do when text (namely measurement values) are altered
        canvas.on('text:editing:exited', function(o){
            //get the edited measurement's associated shape
            var assocShape = canvas.getObjects().filter(o => o.id === canvas.getActiveObject().id && o.category === 'shape');

            if(scalingMode){
                if(canvas.getActiveObject().category === 'dimX'){
                    console.log("You set the scale to:" + canvas.getActiveObject().text/assocShape[0].width);
                    scale = canvas.getActiveObject().text/assocShape[0].getWidth();
                }
                else if(canvas.getActiveObject().category === 'dimY'){
                    console.log("You editied a y-dimension");
                    scale = canvas.getActiveObject().text/assocShape[0].getHeight();
                }
                else if(canvas.getActiveObject().category === 'dimCirc'){
                    scale = (canvas.getActiveObject().text/2)/assocShape[0].getRadiusX();
                }
                document.getElementById("scaleInput").value = scale;
                canvas.setActiveObject(assocShape[0]);
                scaleDimensions();
            }
            else{
                if (canvas.getActiveObject().category == 'dimX'){
                    var widthDif = canvas.getActiveObject().text - assocShape[0].getWidth()*scale;
                    assocShape[0].setWidth(assocShape[0].width + ((widthDif/scale) / assocShape[0].scaleX));
                }
                if (canvas.getActiveObject().category == 'dimY'){
                    var heightDif = canvas.getActiveObject().text - assocShape[0].getHeight()*scale;
                    assocShape[0].setHeight(assocShape[0].height + (heightDif/scale) / assocShape[0].scaleY);
                }
                if (canvas.getActiveObject().category == 'dimCirc'){
                    var radDif = canvas.getActiveObject().text/2 - assocShape[0].getRadiusX()*scale;
                    assocShape[0].setRadius(assocShape[0].radius + (radDif/scale) / assocShape[0].scaleX);
                }
                canvas.setActiveObject(assocShape[0]);
                scaleDimensions('text');
            }
        });

        //  what to do when mouse button is down
        canvas.on('mouse:down', function(o){
            isDown = true;
            var pointer = canvas.getPointer(o.e);
            origX = pointer.x;
            origY = pointer.y;

            if (drawingRect){
                rect = new fabric.Rect({
                    left: origX,
                    top: origY,
                    originX: 'left',
                    originY: 'top',
                    width: pointer.x-origX,
                    height: pointer.y-origY,
                    angle: 0,
                    fill: 'rgba(0,0,0,0)',
                    stroke: 'black',
                    strokeWidth: 2,
                    category: 'shape',
                    id: '1'
                });
                canvas.add(rect);
            }
            if (drawingCircle){
                circ = new fabric.Circle({
                    left: origX,
                    top: origY,
                    originX: 'left',
                    originY: 'top',
                    radius: (pointer.x-origX)/2,
                    fill: 'rgba(0,0,0,0)',
                    stroke: 'black',
                    strokeWidth: 2,
                    category: 'shape',
                    id: '2'
                });
                //prevent circle from being scaled on its x/y axis, ensuring it stays a circle
                circ.lockUniScaling = true;
                canvas.add(circ);
            }
            if (drawingLine){
                var points = [pointer.x, pointer.y, pointer.x, pointer.y];
                startx[temp] = pointer.x;
                starty[temp] = pointer.y;
                line = new fabric.Line(points, {
                    originX: 'center',
                    originY: 'center',
                    stroke: 'black',
                    strokeWidth: 2
                });
                canvas.add(line);
            }
            if (canvasInteractive){
                if (canvas.getActiveObject() != null){
                    canvas.getActiveObject().on('moving', updateDimensions);
                    canvas.getActiveObject().on('rotating', updateDimensions);
                    //canvas.getActiveObject().on('scaling', updateDimensions);

                    canvas.getActiveObject().on('scaling', scaleDimensions);
                    bindDimensions();
                }
            }
        });

        //  what to do when the mouse moves
        canvas.on('mouse:move', function(o){
            canvas.remove(text);
            canvas.renderAll();

            // do not do anything if mouse is not down
            if (!isDown) return;
            var pointer = canvas.getPointer(o.e);
            if (drawingRect){
                if(origX>pointer.x){
                rect.set({ left: Math.abs(pointer.x) });
                }
                if(origY>pointer.y){
                    rect.set({ top: Math.abs(pointer.y) });
                }

                rect.set({ width: Math.abs(origX - pointer.x) });
                rect.set({ height: Math.abs(origY - pointer.y) });

                endx[temp] = pointer.x;
                endy[temp] = pointer.y;

                text = new fabric.Text('Width: ' + Math.round(rect.getWidth()*scale) + '\nHeight: ' + Math.round(rect.getHeight()*scale), { left: endx[temp], top: endy[temp], fontSize: 25 });

                //canvas.add(text);

                //canvas.renderAll();
            }
            if (drawingCircle){
                if(origX>pointer.x){
                circ.set({ left: Math.abs(pointer.x) });
                }
                if(origY>pointer.y){
                    circ.set({ top: Math.abs(pointer.y) });
                }

                circ.set({ radius: Math.abs((origX - pointer.x)/2) });


                //canvas.renderAll();
            }
            if (drawingLine){
                line.set({ x2: pointer.x, y2: pointer.y });

                endx[temp] = pointer.x;
                endy[temp] = pointer.y;

                var dist = Calculate.lineLength(startx[temp], starty[temp], endx[temp], endy[temp]).toFixed(2);
                text = new fabric.Text('Length: ' + dist, { left: endx[temp], top: endy[temp], fontSize: 25 });

                canvas.add(text);
            }
            canvas.renderAll();
        });

        //  what do when mouse button is lifted
        canvas.on('mouse:up', function(o){
            isDown = false;
            var hopefullyUniqueId = Math.random().toString(16).slice(2);
            if(drawingRect){
                rect.set({ id: hopefullyUniqueId });
                if (rect.width != 0 && rect.height != 0){

                    console.log('Initial width: ' + Math.round(rect.getWidth()*scale));

                    dimXLeft = new fabric.Text('‚üµ', { left: rect.left, top: rect.top - 50, fontSize: 29, arrow: 'left', id: rect.id, category: 'dimX'});
                    dimX = new fabric.Textbox(' ' + Math.round(rect.getWidth()*scale) + ' ', { left: dimXLeft.left + dimXLeft.width, top: rect.top - 50, fontSize: 29, width: rect.getWidth() - dimXLeft.width*2, textAlign: 'center', id: rect.id, category: 'dimX', hidden: false  });
                    dimXRight = new fabric.Text('‚ü∂', { left: dimXLeft.left + dimX.width + dimXLeft.width, top: rect.top - 50, fontSize: 29, id: rect.id, arrow: 'right', category: 'dimX', hidden: false  });

                    dimYTop = new fabric.Text('‚ü∂', { left: rect.left - 50, top: rect.top + 35, fontSize: 29, angle: 270, id: rect.id, arrow: 'left', category: 'dimY', hidden: false  });
                    dimY = new fabric.Textbox(' ' + Math.round(rect.getHeight()*scale) + ' ', { left: rect.left - 50, width: rect.getHeight() - dimYTop.height*2, fontSize: 29, angle: 270, textAlign: 'center', id: rect.id, category: 'dimY', hidden: false  });
                    dimY.set({ top: rect.top + dimY.width + 30});
                    dimYBottom = new fabric.Text('‚üµ', { left: rect.left - 50, top: rect.top + dimY.width + dimYTop.width*2 - 2, fontSize: 29, angle: 270, id: rect.id, arrow: 'right', category: 'dimY', hidden: false });

                    rect.setCoords();
                    //  TODO: Insert code block(s) to adjust font-size of dimensions if rect a certain size

                    canvas.add(dimXLeft, dimX, dimXRight, dimYTop, dimY, dimYBottom);
                }
            }
            else if (drawingCircle){
                circ.set({ id: hopefullyUniqueId });
                if (circ.radius != 0){
                    dimXLeft = new fabric.Text('‚üµ', { left: circ.left, top: circ.top - 50, fontSize: 29, id: circ.id, arrow: 'left', category: 'dimCirc', arrow: 'left', hidden: false });
                    dimX = new fabric.Textbox(' ' + Math.round((circ.getRadiusX()*2)*scale) + ' ', { left: dimXLeft.left + dimXLeft.width, top: circ.top - 50, fontSize: 29, width: circ.radius*2 - dimXLeft.width*2, textAlign: 'center', id: circ.id, category: 'dimCirc', hidden: false  });
                    dimXRight = new fabric.Text('‚ü∂', { left: dimXLeft.left + dimX.width + dimXLeft.width, top: circ.top - 50, fontSize: 29, id: circ.id, category: 'dimCirc', arrow: 'right', hidden: false  });

                    circ.setCoords();
                    canvas.add(dimXLeft, dimX, dimXRight);
                }
            }
            else if(drawingLine){
                line.set({ id: hopefullyUniqueId });
            }

            //  Apply common properties to dimension objects
            if (drawingRect  || drawingCircle || drawingLine){
                var dims = [dimXLeft, dimX, dimXRight, dimYTop, dimY, dimYBottom];
                if (!drawingRect){
                    dims = [dimXLeft, dimX, dimXRight]
                }
                dims.forEach(function (dimObject) {
                    //  Disable scaling/rotation controls
                    dimObject.setControlsVisibility({ bl: false, br: false, tl: false, tr: false, mt: false, mb: false, mr: false, ml: false, mtr: false });

                    //  Set common properties
                    dimObject.set({ hidden: false, positionOutside: true });

                });
            }

            //  if user (single) clicked on a textbox, enter editing mode and highlight all contents.
            if (canvas.getActiveObject() && canvas.getActiveObject().isType('textbox')){
                canvas.getActiveObject().enterEditing();
                canvas.getActiveObject().selectAll();
            }

            setInteractive();
            setInteractive();
        });


        //  http://jsfiddle.net/ydtt94zm/2/
        var Calculate={
			lineLength:function(x1, y1, x2,y2){
				return Math.sqrt(Math.pow(x2*1-x1*1, 2)+Math.pow(y2*1-y1*1, 2));
			}
		}

        var multiply = fabric.util.multiplyTransformMatrices;
        var invert = fabric.util.invertTransform;

        function updateDimensions() {

            var dims = canvas.getObjects().filter(o => o.id === canvas.getActiveObject().id);


            dims.forEach(o => {
                if (!o.relationship) {
                    return;
                }
                var relationship = o.relationship;
                var newTransform = multiply(canvas.getActiveObject().calcTransformMatrix(), relationship);
                opt = fabric.util.qrDecompose(newTransform);
                o.set({
                flipX: false,
                flipY: false,
                });
                o.setPositionByOrigin(
                { x: opt.translateX, y: opt.translateY },
                'center',
                'center'
                );
                if (canvas.getActiveObject() === 'shape'){
                    if (o.category === 'dimX' && o.isType('textbox')){
                    o.set({ text: ' ' + Math.round((canvas.getActiveObject().getWidth())*scale) + ' ' }) ;
                    }
                    if (o.category === 'dimY' && o.isType('textbox')){
                        o.set({ text: ' ' + Math.round((canvas.getActiveObject().getHeight())*scale) + ' ' });
                    }
                    if (o.category === 'dimCirc' && o.isType('textbox')){
                        o.set({ text: ' ' + Math.round((canvas.getActiveObject().getRadiusX()*2)*scale) + ' ' });
                    }
                }


                o.set(opt);
                o.setCoords();
            });
        }

        function scaleDimensions(){
            var dims = canvas.getObjects().filter(o => o.id == canvas.getActiveObject().id);
            var valWidth, valHeight, valCirc;

            dims.forEach(o => {
                if (o.category === 'dimX'){
                    if (o.isType('textbox')) {
                        o.set({ width: Math.round(canvas.getActiveObject().getWidth()) - arrowWidth * 2});
                        o.set({ left: canvas.getActiveObject().left + arrowWidth});
                        o.set({ text: ' ' + Math.round(canvas.getActiveObject().getWidth() * scale)  + ' '});
                        valWidth = o.getWidth();
                    }
                    if (o.arrow === 'left'){
                        o.set({ left: canvas.getActiveObject().left});
                    }
                    if (o.arrow === 'right'){
                        o.set({ left: canvas.getActiveObject().left + valWidth + arrowWidth});
                    }

                    if (o.positionOutside){
                        o.set({ top: canvas.getActiveObject().top - 50});
                    }
                    else{
                        o.set({ top: canvas.getActiveObject().top + 25 });
                    }
                }
                if (o.category === 'dimY'){
                    if (o.isType('textbox')){
                        o.set({ width: Math.round(canvas.getActiveObject().getHeight()) - arrowWidth*2});
                        valHeight = o.getWidth();
                        //o.set({ left: canvas.getActiveObject().left - 50});
                        o.set({ top: canvas.getActiveObject().top + valHeight + 30});
                        o.set({ text: ' ' + Math.round(canvas.getActiveObject().getHeight()*scale) + ' '})
                    }
                    if (o.arrow === 'left'){
                        //o.set({ left: canvas.getActiveObject().left - 50});
                        o.set({ top: canvas.getActiveObject().top + 35});
                    }
                    if (o.arrow === 'right'){
                        //o.set({ left: canvas.getActiveObject().left - 50});
                        o.set({ top: canvas.getActiveObject().top + valHeight + arrowWidth*2 - 2});
                    }

                    if (o.positionOutside){
                        o.set({ left: canvas.getActiveObject().left - 50});
                    }
                    else{
                        o.set({ left: canvas.getActiveObject().left + 25});
                    }
                }
                if (o.category === 'dimCirc'){
                    if (o.isType('textbox')){
                        o.set({ width: Math.round(canvas.getActiveObject().getRadiusX()*2) - arrowWidth*2 });
                        valCirc = o.getWidth();
                        console.log("Circ Dim width: " + valCirc);
                        o.set({ left: canvas.getActiveObject().left + arrowWidth });
                        //o.set({ top: canvas.getActiveObject().top - 50 });
                        o.set({ text: ' ' + Math.round((canvas.getActiveObject().getRadiusX()*2)*scale) + ' '});
                    }
                    if (o.arrow === 'left'){
                        o.set({ left: canvas.getActiveObject().left });
                        //o.set({ top: canvas.getActiveObject().top - 50 });
                    }
                    if (o.arrow === 'right'){
                        o.set({ left: canvas.getActiveObject().left + valCirc + arrowWidth });
                        //o.set({ top: canvas.getActiveObject().top - 50 });
                    }

                    if (o.positionOutside){
                        o.set({ top: canvas.getActiveObject().top - 50 });
                    }
                    else{
                        o.set({ top: canvas.getActiveObject().top + canvas.getActiveObject().getRadiusX()*0.85});
                    }
                }
            });
            canvas.getActiveObject().setCoords();
            canvas.renderAll();
        }

        function bindDimensions() {
            var dims = canvas.getObjects().filter(o => o.id == canvas.getActiveObject().id);
            var shapeTransform = canvas.getActiveObject().calcTransformMatrix();
            var invertedshapeTransform = invert(shapeTransform);
            dims.forEach(o => {
                var desiredTransform = multiply(
                invertedshapeTransform,
                o.calcTransformMatrix()
                );
                // save the desired relation here.
                o.relationship = desiredTransform;
            });
        }
    </script>
                <br>
            </div>
        </div>
        <div class="row">
            <div class="container-fluid site-footer">
                <span class="sig">Sketch-It-Yourself</span>
                <p style="color: #c1c1c1; font-size: 15px; font-family: 'Times New Roman', Serif;">Completed as part of the MSc Computing Science programme at the University of Glasgow &copy; 2018</p>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</body>
</html>